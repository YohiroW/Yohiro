---
title: 关于 Unreal 5.x 新特性使用情况的调查
author: Yohiro
date: 2023-11-28
categories: []
tags: []
render_with_liquid: false
img_path: /assets/images/Remnant2/
---

为了解 Unreal 5.x 新特性在已发布的游戏中的使用情况，这里追踪了 Remnant2 以及 RoboCop 的渲染情况。为获得尽可能真实可信的数据，以下抓帧时的数据均在关闭了诸如 DLSS 之类的超分技术和动态分辨率，且关闭垂直同步的情况下获取。

---

## Remnant2

### Overview

| Pass        | Number | GPU Time[^Tip] |
|:------------|:-------|:---------------|
| PrePass     | 357    | 3.96           |
| BasePass    | 453    | 2.92           |
| ShadowDepth | 485    | 15.36          |
| Translucent | 60     | 0.12           |
| Other       | 162    | 2.98           |
| Total       | 1517   | 25.34          |

### Shadow

根据 Overview 中的表格，ShadowDepth 占用了最多的 GPU 时间，而且 PrePass 耗时也超过了 BasePass，可见整个场景的瓶颈在于`顶点数过多`。

在开启了 Nanite 的情况下，Remnant2 并`没有启用 VSM`。根据官方文档中所说[^VSM]，Nanite几何体始终渲染到虚拟阴影贴图，是性能最高的选项，可提供最高质量。然而这个游戏中并没有使用 VSM。手动开启 VSM 后，发现渲染线程时间和 GPU 时间均获得了 2 ms 左右的提升，没有使用 VSM 也许是考虑到显存的占用，为的是取得 Texture 和 Nanite Mesh 之间的平衡？

从抓帧的数据来看，耗时较高的几个 DrawCall 都是来自于 ShadowDepth Pass 中，考虑下面的这个 DrawCall:

![ShadowDepth](ShadowDepth_Hot.png){: .shadow .rounded-10 }
_某个 PLA 的 ShadowDepth_

直接使用了 LOD 0 的 Mesh 去投射阴影，除了这个 DrawCall 外还有许多零碎的小物件，这些都增加了 ShadowDepth 的负荷。针对这种情况，通常的方案是使用代理网格或是低级的 LOD 来投射阴影。如果是因为 ShadowMap 的分辨率问题导致的 Cache miss 还要考虑 ShadowMap 的压缩。

Unreal 中提供了多种阴影方案，这个游戏中也使用了不止一种，这里仅考虑高顶点数造成瓶颈的问题。

### Nanite

开启与关闭 Nanite，Stats 信息中的 Prims 数量有着巨大的差别，这是因为开启 Nanite 后，GNumPrimitivesDrawnRHI 中没有统计 Nanite 的图元数量，如果需要观测 Nanite 的情况，需要使用 `r.Nanite.ShowStats` 来开启 Nanite 的 Stats 面板。

Nanite 效果最为明显的是树冠，下面的树有 256,891 个顶点，在 PrePass, BasePass 以及 ShadowDepth 均有较高的耗时。

![Tree](Foliage_Hot.png){: .shadow .rounded-10 }
_Nsight 中树的 Geometry_

### Lumen的替代方案

根据工作室采访时所说[^Ref]，Remnant2 中并没有使用 Lumen。取而代之的是 Unreal 5.x 中的 Fallback 方案，即使用了 SSGI 的方式模拟全局光。

严格来说，开启 GI 后，AO 的开启与否是需要讨论的。一方面是因为 GI 已经提供了具有真实感的光照和阴影，另一方面是因为当前的 GI 方案并不完善，总是存在没有捕捉到的地方，尤其是对 SSGI 而言。因此在角落、拐角、裂缝等处的 AO 依然是必要的。

所以我觉得 SSGI + DFAO + SSR 可以作为一个 Lumen 的替代方案。不过，上个月的 Unreal Fest Day[^Fest] 中，Epic 的一位老哥给给出了这样的建议：

![LumenFallback](LumenFallback.png){: .shadow .rounded-10 w='767' h='390' }
_详情见油管视频_

即关闭 GI 用 AO + SSR 作为 Fallback 方案，这种方式就是回归了原先 4.x 的管线。当然，具体问题具体分析，最重要的还是要考虑场景美术想要表达的效果。

## RoboCop

### Overview

## References

[^Tip]: GPU Time 来自 Nsight 中的数据，具体到某一 Pass 并不准确，相对大小可供参考。
[^VSM]: [虚拟阴影贴图](https://docs.unrealengine.com/5.3/zh-CN/virtual-shadow-maps-in-unreal-engine/)
[^Ref]: [Remnant II Is Powered by UE5, Though It Doesn’t Use Lumen Yet](https://wccftech.com/remnant-ii-is-powered-by-ue5-though-it-doesnt-use-lumen-yet/)
[^Fest]: [Unreal Fest Day 2 \| Livestream 2 Pt. 2](https://www.youtube.com/watch?v=8eO2xdrDms8)
