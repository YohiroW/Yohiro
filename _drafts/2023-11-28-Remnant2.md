---
title: 关于 Unreal 5.x 新特性使用情况的调查
author: Yohiro
date: 2023-11-28
categories: []
tags: []
render_with_liquid: false
img_path: /assets/images/Remnant2/
---
## Intro

为了解 Unreal 5.x 新特性在已发布的游戏中的使用情况，这里追踪了 Remnant2 以及 RoboCop 的渲染情况，虽然优化是这两款游戏被诟病的点，但是知道了使用 5.x 的游戏的问题在哪里，我们在以后的开发里也可以加以避免。为获得尽可能真实可信的数据，以下抓帧时的数据均在关闭了诸如 DLSS 之类的超分技术和动态分辨率，中画质 1080p 且关闭垂直同步的情况下获取。

硬件环境：

- i7-10700 2.90GHz
- NVIDIA RTX 2060

## Remnant2

Remnant2 中对新特性的使用非常保守，仅开启了 Nanite。抓帧的位置是新游戏的出生点，具有较多的植被，部分数冠的顶点数非常多。在该场景的 BasePass 中可以看到，所有的 Draw 都来自于 Nanite。

---

| Pass        | Number | GPU Time[^Tip] |
|:------------|:-------|:---------------|
| PrePass     | 357    | 3.96           |
| BasePass    | 453    | 2.92           |
| ShadowDepth | 485    | 15.36          |
| Translucent | 60     | 0.12           |
| Other       | 162    | 2.98           |
| Total       | 1517   | 38.58          |

### Virtual Shadow Map

根据 Overview 中的表格，ShadowDepth 占用了最多的 GPU 时间，而且 PrePass 耗时也超过了 BasePass，可见整个场景的瓶颈在于`顶点数过多`。

在开启了 Nanite 的情况下，Remnant2 并`没有启用 VSM`。根据官方文档中所说[^VSM]，Nanite几何体始终渲染到虚拟阴影贴图，是性能最高的选项，可提供最高质量。然而这个游戏中并没有使用 VSM。手动开启 VSM 后，发现渲染线程时间和 GPU 时间均获得了 2 ms 左右的提升，没有使用 VSM 也许是考虑到显存的占用，为的是取得 Texture 和 Nanite Mesh 之间的平衡？

从抓帧的数据来看，耗时较高的几个 DrawCall 都是来自于 ShadowDepth Pass 中，考虑下面的这个 DrawCall:

![ShadowDepth](ShadowDepth_Hot.png){: .shadow .rounded-10 }
_某个 PLA 的 ShadowDepth_

直接使用了 LOD 0 的 Mesh 去投射阴影，除了这个 DrawCall 外还有许多零碎的小物件，这些都增加了 ShadowDepth 的负荷。针对这种情况，通常的方案是使用代理网格或是低级的 LOD 来投射阴影。如果是因为 ShadowMap 的分辨率问题导致的 Cache miss 还要考虑 ShadowMap 的压缩。

Unreal 中提供了多种阴影方案，这个游戏中也使用了不止一种，这里仅考虑高顶点数造成瓶颈的问题。

### Nanite

开启与关闭 Nanite，Stats 信息中的 Prims 数量有着巨大的差别，这是因为开启 Nanite 后，GNumPrimitivesDrawnRHI 中没有统计 Nanite 的图元数量，如果需要观测 Nanite 的情况，需要使用 `r.Nanite.ShowStats` 来开启 Nanite 的 Stats 面板。

Nanite 效果最为明显的是树冠，下面的树的 Nanite Fallback Mesh 有 256,891 个顶点，在 PrePass, BasePass 以及 ShadowDepth 均有较高的耗时。

![Tree](Foliage_Hot.png){: .shadow .rounded-10 }
_Nsight 中树的 Geometry_

### Lumen

根据工作室采访时所说[^Ref]，Remnant2 中并没有使用 Lumen，通过导出的设置来看，Mesh 也没有生成 SDF。取而代之的是 Unreal 5.x 中的 Fallback 方案，即使用了 SSGI 的方式模拟全局光，而且是`半分辨率`的 SSGI。

严格来说，开启 GI 后，AO 的开启与否是需要讨论的。一方面是因为 GI 已经提供了具有真实感的光照和阴影，另一方面是因为当前的 GI 方案并不完善，总是存在没有捕捉到的地方，尤其是对 SSGI 而言。因此在角落、拐角、裂缝等处的 AO 依然是必要的。

所以我觉得 SSGI + DFAO + SSR 可以作为一个 Lumen 的替代方案。不过，上个月的 Unreal Fest Day[^Fest] 中，Epic 的一位老哥给给出了这样的建议：

![LumenFallback](LumenFallback.png){: .shadow .rounded-10 w='767' h='390' }
_详情见油管视频  52min47s_

即关闭 GI 用 AO + SSR 作为 Fallback 方案，这种方式就是回归了原先 4.x 的管线。但是在成品的游戏中，如果没有烘焙光照贴图，没有了 GI 会使画面的差距过大。

## RoboCop

RoboCop 使用了 UE5 所有的新特性，是非常标准的 5.x 的游戏。抓帧的位置同样来自游戏的出生点，场景是位于小巷中，因此顶点数不像前者那么多，地面的积水部分比较能反映 Lumen 的效果。

---

### Virtual Shadow Map




### Nanite

除了目前尚不支持的对蒙皮网格、透明物件的渲染以及贴花以外，场景中所有的 Mesh 几乎都使用了 Nanite。但是不同于前者，在全局关掉 Nanite 的支持后，没有使用 Fallback Mesh 替代，应该是修改了 ProxyRenderMode。

而且这个游戏也允许走软光栅的（一般是应用了 WPO 的材质） Mesh 进入 Shadow Pass。

### Lumen

Lumen 的耗时在我的机器上是 5.4 ms 左右，按照 Epic 老哥的说法，在 60 fps 下 Lumen 的 Budget 应该限制在 4 ms, 在 30 fps 下应该限制在 8 ms。

下面的反射使用了较为粗糙的追踪，应该是关掉了 TraceMeshSDFs。

![Lumen_Reflection](RoboCop_Low.png){: .shadow .rounded-10 }

在使用 GI 的情况下，可以考虑仅改变不同的反射方法进行性能分级。这里是两个不同的反射方法的效果对比（Lumen vs SSR）：

![Comparsion of Lumen and SSR](RoboCop_Reflection.png){: .shadow .rounded-10 }
_Comparsion of Lumen and SSR (1)_

![Comparsion of Lumen and SSR](RoboCop_Reflection2.png){: .shadow .rounded-10 }
_Comparsion of Lumen and SSR (2)_

RoboCop 在中高配均开启了 Lumen，在低配机上关掉了 GI，也关掉了反射。

## 其他

还有些其他的发现，比如 RoboCop 中的角色皮肤使用了半分辨率的次表面散射。对于 SceneColor 的格式，Remnant2 使用了 RGBA，而 RoboCop 使用了 RGB + SeparateTranslucency。

## Summary

至少从目前抓帧的两处来看，Remnant2 的几何复杂程度是更高的。

## References

[^Tip]: GPU Time 来自 Nsight 中的数据，具体到某一 Pass 并不准确，相对大小可供参考。
[^VSM]: [虚拟阴影贴图](https://docs.unrealengine.com/5.3/zh-CN/virtual-shadow-maps-in-unreal-engine/)
[^Ref]: [Remnant II Is Powered by UE5, Though It Doesn’t Use Lumen Yet](https://wccftech.com/remnant-ii-is-powered-by-ue5-though-it-doesnt-use-lumen-yet/)
[^Fest]: [Unreal Fest Day 2 \| Livestream 2 Pt. 2](https://www.youtube.com/watch?v=8eO2xdrDms8)
