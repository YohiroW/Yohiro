---
title: Remnant2
author: Yohiro
date: 2023-11-28
categories: []
tags: []
render_with_liquid: false
img_path: /assets/images/Remnant2/
---
## 概述

| Pass | Number | GPU Time[^Tip] |
|:--|:--|:--|
| PrePass | 357 | 3.96 |
| BasePass | 453 | 2.92 |
| ShadowDepth | 485 | 15.36 |
| Translucent | 60 | 0.12 |
| Other | 162 | 2.98 |
| Total | 1517 | 25.34 |

[^Tip]: GPU Time 来自 Nsight 中的数据，具体到某一 Pass 并不准确，仅相对大小可供参考。

## Shadow

根据 Overview 中的表格，ShadowDepth 占用了最多的 GPU 时间，而且 PrePass 耗时也超过了 BasePass 可见整个场景的瓶颈在于`顶点数过多`。

从抓帧的数据来看，耗时较高的几个 DrawCall 都是来自于 ShadowDepth Pass 中，考虑下面的这个 DrawCall:

![ShadowDepth](ShadowDepth_Hot.png)
_某个 PLA 的 ShadowDepth_

看起来直接用了 LOD 0 的 Mesh 去投射阴影，除了这个 DrawCall 外还有许多零碎的小物件，这些都增加了 ShadowDepth 的负荷。针对这种情况，通常的方案是使用代理网格或是低级的 LOD 来投射阴影。如果是因为 ShadowMap 的分辨率问题导致的 Cache miss 还要考虑 ShadowMap 的压缩。

Unreal 中提供了多种阴影方案，这个游戏中也使用了不止一种，这里仅考虑高顶点数造成瓶颈的问题。

## Nanite

开启与关闭 Nanite，Stats 信息中的 Prims 数量有着巨大的差别，这是因为开启 Nanite 后，GNumPrimitivesDrawnRHI 中没有统计 Nanite 的图元数量，如果需要观测 Nanite 的情况，需要使用 `r.Nanite.ShowStats` 来开启 Nanite 的 Stats 面板。

Nanite 效果最为明显的是树冠，下面的树有 280,000 个顶点，在 PrePass, BasePass 以及 ShadowDepth 均有较高的耗时。

![Tree](Foliage_Hot.png)
_Nsight 中树的 Geometry_

既然顶点这么多，就不必使用 Mask 材质，使用的贴图也就不需要 alpha 通道了。

## Lumen的替代方案

根据工作室采访时所说[^Ref]，Remnant2 中并没有使用 Lumen。取而代之的是 Unreal 5.x 中的 Fallback 方案，即使用了 SSGI 的方式模拟全局光。

严格来说，开启 GI 后，AO 的开启与否是需要讨论的。一方面是因为 GI 已经提供了具有真实感的光照和阴影，另一方面是因为当前的 GI 方案并不完善，总是存在没有捕捉到的地方，尤其是对 SSGI 而言。因此在角落、拐角、裂缝等处的 AO 依然是必要的。

从抓帧的结果里也可以发现，该游戏中依然使用了 Reflection Capture。可能是因为项目是从 4.x 升上来的，也可能是因为上面所说的，需要为 SSGI 添加补偿。

所以我觉得 SSGI + DFAO + SSR 可以作为一个 Lumen 的替代方案。当然，最重要的还是要考虑场景美术想要表达的效果。

[^Ref]: [Remnant II Is Powered by UE5, Though It Doesn’t Use Lumen Yet](https://wccftech.com/remnant-ii-is-powered-by-ue5-though-it-doesnt-use-lumen-yet/)

## Post Processing

后处理效果没有太复杂，当前帧使用了 Bloom, Color Grading, Eye Adaption 和 Tone Mapping，最后面跟着 TAA Pass。
